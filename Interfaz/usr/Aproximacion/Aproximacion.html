<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aproximacion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
          integrity="sha512-T6ZL9V3u+D+F7sqPjE+JnJSGekC6DBi6s78O/DfvOJYz9vp3+T/qDlkCY1waVwFJuSG76eQUquvlQ0uWuSXlPQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <link href="/Interfaz/CSS/navusr.css" rel="stylesheet">
    <link href="/Interfaz/CSS/Emergencia.css" rel="stylesheet">
    <link href="/CSS/Cards.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f2f2f2;
        }

        .contenedor-header {
            flex: 0 0 auto;
        }

        .container {
            flex: 1 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .form-container {
            background-color: #c0eaf9;
            width: 30%;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            height: 50%; /* Cambia esta línea según el alto deseado */
            overflow: auto; /* Añade esta línea para agregar desplazamiento vertical si el contenido es demasiado largo */
        }

        .title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

            .form-group label {
                font-weight: bold;
                margin-right: 10px;
            }

            .form-group input[type="text"],
            .form-group textarea {
                flex: 1;
                padding: 8px;
                border-radius: 5px;
                border: 1px solid #ccc;
            }

            .form-group span {
                padding: 8px;
                border-radius: 5px;
                background-color: #f0f0f0;
                border: 1px solid #ccc;
                text-align: center;
            }

            .form-group button {
                width: 100%;
                padding: 10px;
                background-color: #4CAF50;
                border: none;
                color: white;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }

                .form-group button:hover {
                    background-color: #45a049;
                }
    </style>
</head>



<body>
    <div class="contenedor-header">
        <header>
            <nav>
                <div class="mini-nav">
                    <img src="https://tiusr26pl.cuc-carrera-ti.ac.cr/Imagenes/Logo.PNG" />
                    <div class="text-container">
                        <p>Sky Guardian</p>
                        <p>Protegiendo cada vuelo, cuidando cada paso.</p>
                    </div>
                </div>
                <ul style="align-items: center;">
                    <li class="nav-item">
                        <button id="btnEmergencia" type="button" class="btn btn-danger" data-bs-toggle="modal"
                                data-bs-target="#modalEmergencia">
                            Emergencia
                        </button>
                    </li>
                    <li>
                        <a id="lblDashboard" class="navbar-brand" href="/Interfaz/usr/General/Home.html">Dashboard</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                                aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </li>
                    <li>
                        <a id="lblAirplaneLanding" class="navbar-brand" href="/Interfaz/usr/Aterrizaje/ListaAterrizaje.html">lblAirplaneLanding</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                                aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </li>
                    <li>
                        <a id="lblAirplaneApproach" class="navbar-brand" href="/Interfaz/usr/Aproximacion/Aproximacion.html">lblAirplaneApproach</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                                aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </li>
                    <li>
                        <a id="lblEmergencyReports" class="navbar-brand" href="/Interfaz/usr/General/Emergencia.html">lblEmergencyReports</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                                aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </li>

                </ul>
            </nav>
        </header>
    </div>
    <div class="container">
        <div class="form-container">
            <div class="title">Registrar Aproximación</div>
            <div class="form-group">
                <label for="distancia">Distancia Restante:</label>
                <input type="text" id="distancia" name="distancia">
                <span>km</span>
            </div>
            <div class="form-group">
                <label for="angulo">Ángulo de Descenso:</label>
                <input type="text" id="angulo" name="angulo">
                <span>&deg;</span>
            </div>
            <div class="form-group">
                <label for="comentarios">Comentarios:</label>
                <textarea id="comentarios" name="comentarios"></textarea>
            </div>
            <div class="form-group">
                <button onclick="registrarAproximacion()">Crear</button>
            </div>
        </div>
    </div>
    <script>
        // Función para obtener el último ID de aproximación utilizado
        function obtenerUltimoIdAproximacion() {
            const ultimoId = localStorage.getItem('ultimoIdAproximacion');
            return ultimoId ? parseInt(ultimoId) : 0;
        }

        // Función para almacenar el último ID de aproximación utilizado
        function almacenarUltimoIdAproximacion(id) {
            localStorage.setItem('ultimoIdAproximacion', id);
        }

        // Función para obtener la fecha actual en formato ISO
        function obtenerFechaActual() {
            return new Date().toISOString();
        }

        // Función para hacer el POST en la tabla de aproximación
        async function registrarAproximacion() {
            try {
                const distancia = document.getElementById('distancia').value;
                const angulo = document.getElementById('angulo').value;
                const comentarios = document.getElementById('comentarios').value;
                const idVuelo = obtenerIdVueloDeURL();

                // Obtener el último ID de aproximación utilizado
                let idAproximacion = obtenerUltimoIdAproximacion() + 1;

                // Objeto con los datos a enviar en el POST
                const postData = {
                    IdAproximacion: idAproximacion,
                    IdVuelo: idVuelo,
                    HoraRegistro: obtenerFechaActual(),
                    IdInformacionMetereologica: 1, // Valor predeterminado
                    DistanciaRestante: distancia,
                    AnguloDescenso: angulo,
                    Comentarios: comentarios,
                    PermisoSobrevuelo: true,
                    IdEmergencia: 1, // Valor predeterminado
                    IdTipoAproximacion: 1, // Valor predeterminado
                    IdEstadoAproximacion: 1, // Valor predeterminado
                };

                const response = await fetch('https://tiusr26pl.cuc-carrera-ti.ac.cr/BackendST/api/Aproximacion/CrearAproximacion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                // Verificar si la solicitud fue exitosa
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Aproximación registrada exitosamente:', responseData);
                    alert('Aproximación registrada exitosamente.');
                    // Almacenar el último ID de aproximación utilizado
                    almacenarUltimoIdAproximacion(idAproximacion);
                    // Actualizar el estado del vuelo
                    await actualizarEstadoVuelo(idVuelo);
                } else {
                    console.error('Error al registrar aproximación:', response.statusText);
                    alert('Error al registrar aproximación. Por favor, inténtalo de nuevo.');
                }
            } catch (error) {
                console.error('Error en la solicitud POST:', error);
                alert('Error en la solicitud POST. Por favor, inténtalo de nuevo.');
            }
        }

        // Función para obtener el IdVuelo de la URL
        function obtenerIdVueloDeURL() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            return urlParams.get('id');
        }

        async function actualizarEstadoVuelo(idVuelo) {
            try {
                const putData = 4; // Solo el nuevo ID de estado, sin corchetes ni formato JSON

                const response = await fetch(`https://tiusr26pl.cuc-carrera-ti.ac.cr/BackendST/api/Vuelos/ActualizarEstado/${idVuelo}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: putData // Solo el número 4 como cuerpo de la solicitud
                });

                if (response.ok) {
                    const responseData = await response.text(); // Obtener el cuerpo de la respuesta como texto
                    console.log('Estado del vuelo actualizado exitosamente:', responseData);
                    window.location.href = 'Vuelos.html';
                } else {
                    console.error('Error al actualizar estado del vuelo:', response.statusText);
                    alert('Error al actualizar estado del vuelo. Por favor, inténtalo de nuevo.');
                }
            } catch (error) {
                console.error('Error en la solicitud PUT:', error);
                alert('Error en la solicitud PUT. Por favor, inténtalo de nuevo.');
            }
        }
    </script>
    <script src="/JS/Labels.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</body>

</html>